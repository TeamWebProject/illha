<html layout:decorate="~{layout}" xmlns:layout="http://www.w3.org/1999/xhtml" xmlns:th="http://www.w3.org/1999/xhtml">
<div layout:fragment="content" class="container my-3">
    <head>
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    </head>
    <form th:action="@{/member/login}" method="post">
                    <div th:if="${param.error}">
                        <div class="alert alert-danger">
                            사용자ID 또는 비밀번호를 확인해 주세요.
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="username" class="form-label">사용자ID</label>
                        <input type="text" name="username" id="username" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">비밀번호</label>
                        <input type="password" name="password" id="password" class="form-control">
                    </div>
                    <div>
                        <button type="submit" class="btn btn-primary" style="display: block; margin-bottom: 10px;">로그인</button>
                    </div>
    </form>

                    <!-- 아이디 찾기 버튼 -->
                    <a href="/member/findId" class="find-common-button" style="margin-top: 20px;">아이디 찾기</a>
                    <div style="display:inline-block;">|</div>
                    <a href="#" data-bs-toggle="modal" data-bs-target="#resetPassword" onclick="resetPassword.show()">
                        비밀번호찾기
                    </a>
                    <div style="width: 100%; text-align: center; border-bottom: 1px solid #ccc; line-height: 0.1em; margin: 10px 0;">
                        <span style="background-color: #fff; padding: 0 10px; font-size: 14px; color: #333;">또는</span>
                    </div>

    <!-- Modal -->
    <div class="modal fade" id="resetPassword" tabindex="-1" aria-labelledby="resetPasswordLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <!-- 비밀번호 찾기 폼 --> <!-- modal-body -->
                    <div class="modal-body">
                        <div class="container my-3 mx-auto">
                                <form th:action="@{/member/findPassword}" method="post" id="find-Password-Form">
                                    <h2 id="resetPasswordLabel">비밀번호 찾기</h2>
                                    <input type="hidden" id="modal-yn" name="modal" th:value="${modal}">
                                    <input type="hidden" name="verificationCodeSent" th:value="${verificationCodeSent}">
                                    <input type="hidden" name="verificationCode" th:value="${verificationCode}">
                                    <div class="mb-3">
                                        <div class="col-md-7 text-md-end">
                                            <label for="memberId" class="form-label">비밀번호를 찾으려는 아이디</label>
                                        </div>
                                        <div class="col-md-3 mx-auto">
                                            <input type="text" name="memberId" id="memberId" class="form-control" required
                                                   th:value="${memberId}">
                                        </div>
                                    </div>
                                    <!-- 추가: 비밀번호 찾기 버튼을 누르면 인증번호가 전송되면, 인증번호 입력란이 나타납니다. -->

                                    <!-- 메시지를 표시하는 부분 -->
                                    <div th:if="${message}" class="row mt-3">
                                        <div class="col-md-12 text-center">
                                            <p th:text="${message}"></p>
                                        </div>
                                    </div>
                                    <div th:unless="${verificationCodeSent}" class="text-md-center">
                                        <button type="submit" class="btn btn-primary btn-lg w-25" onclick="handleDualAction()">다음</button>
                                    </div>
                                    <div th:if="${verificationCodeSent}">
                                        <div class="mb-3">
                                            <div class="col-md-6 text-md-end" style="margin-left:25px;">
                                                <label for="verificationCode" class="form-label">인증번호</label>
                                            </div>
                                            <div class="col-md-3 mx-auto">
                                                <input type="password" name="inputVerificationCode" id="verificationCode"
                                                       class="form-control"
                                                       th:value="${param.inputVerificationCode}">
                                            </div>
                                        </div>

                                    </div>
                                    <div th:if="${verificationCodeSent}" th:unless="${verificationCodeValid}" class="text-md-center">
                                        <button type="submit" class="btn btn-primary btn-lg w-25" onclick="handleDualAction()">다음</button>
                                    </div>
                                    <!-- 수정: 새로운 비밀번호 입력 폼 -->
                                </form>
                            <div th:if="${verificationCodeSent}">
                            <form th:action="@{/member/resendVerificationCode}" method="post" style="position: absolute;
                                  bottom: 100px;
                                  right: 40px;">
                                <input type="hidden" name="verificationCodeSent" th:value="${verificationCodeSent}">
                                <input type="hidden" name="verificationCode" th:value="${verificationCode}">
                                <input type="hidden" name="resendVerificationCode" th:value="${resendVerificationCode}">
                                <input type="hidden" name="verificationCodeValid" th:value="${verificationCodeValid}">
                                <input type="hidden" name="memberId" th:value="${memberId}">
                                <div>
                                    <button>인증번호 재전송</button>
                                </div>

                            </form>
                            </div>
                            <form th:action="@{/member/passwordReset}" method="post">
                                <input type="hidden" name="memberId" th:value="${memberId}">
                                            <input type="hidden" name="verificationCode" th:value="${verificationCode}">
                                            <input type="hidden" name="verificationCodeValid" th:value="${verificationCodeValid}">
                                            <input type="hidden" name="modal" th:value="${modal}">
                                            <div th:if="${verificationCodeValid}">
                                                <div class="mb-3">
                                                    <div class="col-md-12 text-center">
                                                        <label for="newPassword" class="form-label">새로운 비밀번호</label>
                                                    </div>
                                                    <div class="col-md-3 mx-auto">
                                                        <input type="password" name="newPassword" id="newPassword"
                                                               class="form-control" required
                                                               th:value="${newPassword}">
                                                    </div>
                                                    <div class="col-md-12 text-center">
                                                        <label for="newPassword1" class="form-label">비밀번호 확인</label>
                                                    </div>
                                                    <div class="col-md-3 mx-auto">
                                                        <input type="password" name="newPassword1" id="newPassword1"
                                                               class="form-control" required
                                                   th:value="${newPassword1}">
                                        </div>
                                    </div>
                                    <!-- 비밀번호 확인 불일치 시 메시지를 표시 -->
                                    <div class="col-md-12 text-center"
                                         th:if="${not #strings.equals(newPassword, newPassword1)}">
                                        <p class="text-danger">비밀번호가 일치하지 않습니다.</p>
                                    </div>
                                    <div class="text-md-center">
                                        <button type="submit" class="btn btn-primary" onclick="finalFunction()">비밀번호 재설정</button>
                                    </div>
                                </div>
                            </form>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
                        <!-- 소셜로그인 부분-->
                    <div style="display: flex; justify-content:center; align-items: center; margin-top: 50px;">
                    <a href="/oauth2/authorization/google">
                        <img src="/pngwing.com.png" alt="Google Login" style="width: 80px; height: 60px; margin-right: 100px;">
                    </a>
                    <a href="/oauth2/authorization/kakao">
                        <img src="/kakao_login_simple1.png" alt="Kakao Login"
                             style="width: 80px; height: 60px; margin-right: 100px;">
                    </a>
                    <a href="/oauth2/authorization/naver">
                        <img src="/naver_login_button3.png" alt="Naver Login"
                             style="width: 80px; height: 60px; margin-right: 50px;">
                    </a>
                </div>
                </form>

<!-- JavaScript 코드 -->
<!-- 추가: 비밀번호 재설정 성공 시 alert와 페이지 이동을 위한 스크립트 -->
    <script th:if="${param.resetSuccess}">
                    console.log('스크립트 실행 확인');
                    alert('비밀번호가 성공적으로 재설정되었습니다.');
                       window.location.href = '/member/login';
    </script>
    <!-- 스크립트 실행 확인 및 메시지 보여주기 -->
    <script th:if="${showConfirmationScript}" th:inline="javascript">
                    console.log('스크립트 실행 확인');

                    var userEmail = /*[[@{${userEmail}}]]*/ '';
                    function hideEmail(email) {
                        var atIndex = email.indexOf('@');
                        var dotIndex = email.lastIndexOf('.');

                        // "@" 뒤의 첫 글자와 "." 이전의 모든 글자를 가려주는 방법
                        var hiddenPart = email.charAt(atIndex + 1) + email.substring(atIndex + 2, dotIndex).replace(/./g, '*');

                        return email.substring(0, atIndex + 1) + hiddenPart + email.substring(dotIndex);
                    }

                    var hiddenEmail = hideEmail(userEmail);

                    alert('인증번호가 이메일로 전송되었습니다. 이메일을 확인해주세요.\n이메일: ' + hiddenEmail);
    </script>
    <!-- JavaScript 코드 -->
    <!-- 추가: 비밀번호 재설정 성공 시 alert와 페이지 이동을 위한 스크립트 -->
    <script th:if="${param.resetSuccess}">
                    console.log('스크립트 실행 확인');
                    alert('비밀번호가 성공적으로 재설정되었습니다.');
                    // 비밀번호 재설정 후 로그인 폼으로 이동
                    window.location.href = '/member/login';
    </script>

    <!-- JavaScript 모달 기능 코드 -->
    <script th:inline="javascript">
                    if([[${modal}]]) {
                        const resetPassword = new bootstrap.Modal('#resetPassword');
                        const input = document.querySelector('#modal-yn');
                        input.value = [[${modal}]];
                        resetPassword.show();
                    }
    </script>
</div>
</html>